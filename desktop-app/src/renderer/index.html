<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIR Controller Desktop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg0: #040812;
        --bg1: #0d1a2f;
        --panel: rgba(8, 20, 36, 0.8);
        --trace: #3df2cb;
        --warn: #ff9d43;
        --text: #ecf8ff;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "IBM Plex Sans", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 82% 12%, rgba(61, 242, 203, 0.2), transparent 30%),
          radial-gradient(circle at 9% 88%, rgba(255, 157, 67, 0.18), transparent 36%),
          linear-gradient(160deg, var(--bg0), var(--bg1));
        padding: 1.2rem;
      }

      .shell {
        width: min(1180px, 100%);
        margin: 0 auto;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 24px;
        overflow: hidden;
        backdrop-filter: blur(10px);
        background: linear-gradient(170deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.015));
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
      }

      .brand {
        font-family: "Bebas Neue", cursive;
        letter-spacing: 0.08em;
        font-size: 1.85rem;
      }

      .status {
        font-size: 0.78rem;
        font-weight: 700;
        border-radius: 999px;
        padding: 0.32rem 0.62rem;
        border: 1px solid rgba(255, 255, 255, 0.24);
      }

      .status.online {
        border: none;
        color: #032119;
        background: linear-gradient(100deg, var(--trace), #c8fff1);
      }

      main {
        padding: 1rem;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 0.9rem;
      }

      .card {
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        background: var(--panel);
        padding: 0.85rem;
      }

      h2 {
        margin: 0 0 0.6rem;
        font-family: "Bebas Neue", cursive;
        letter-spacing: 0.06em;
        font-size: 1.45rem;
        font-weight: 400;
      }

      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .url {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.45rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem 0.55rem;
      }

      .url code {
        word-break: break-all;
        font-size: 0.8rem;
      }

      .session-shell {
        margin-top: 0.6rem;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.8rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        padding: 0.7rem;
      }

      .session-label {
        font-size: 0.74rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.82;
      }

      .session-code {
        margin-top: 0.12rem;
        font-family: "Bebas Neue", cursive;
        letter-spacing: 0.2em;
        font-size: clamp(1.5rem, 3vw, 2.3rem);
        line-height: 1;
      }

      .session-code.ready {
        color: #9dfce7;
      }

      .qr-panel {
        min-width: 176px;
        display: grid;
        justify-items: center;
        align-content: start;
        gap: 0.35rem;
      }

      .qr-box {
        min-width: 176px;
        min-height: 176px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.07);
        display: grid;
        place-items: center;
        padding: 0.35rem;
      }

      .qr-box canvas,
      .qr-box img {
        border-radius: 8px;
      }

      label {
        display: grid;
        gap: 0.3rem;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        font-weight: 700;
      }

      input,
      select,
      button {
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 0.52rem 0.6rem;
        font-size: 0.88rem;
        font-family: inherit;
      }

      input {
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      button {
        border: none;
        color: #02160f;
        font-weight: 700;
        background: linear-gradient(110deg, var(--trace), #b6fceb);
        cursor: pointer;
      }

      button.subtle {
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
      }

      button.warn {
        color: #311500;
        background: linear-gradient(110deg, var(--warn), #ffc48c);
      }

      .hint {
        margin: 0.35rem 0 0;
        font-size: 0.77rem;
        opacity: 0.86;
      }

      .log {
        margin-top: 0.6rem;
        border: 1px solid rgba(255, 255, 255, 0.19);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.22);
        padding: 0.55rem;
        height: 250px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 0.76rem;
        line-height: 1.35;
        white-space: pre-wrap;
      }

      .log-line {
        margin: 0 0 0.38rem;
      }

      .log-line.stderr,
      .log-line.error {
        color: #ffb8b8;
      }

      .log-line.status {
        color: #9dfce7;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .bridge-list {
        margin-top: 0.5rem;
        display: grid;
        gap: 0.4rem;
      }

      .bridge-item {
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.45rem 0.55rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      .bridge-item code {
        font-size: 0.78rem;
        word-break: break-all;
      }

      @media (max-width: 960px) {
        main {
          grid-template-columns: 1fr;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .session-shell {
          grid-template-columns: 1fr;
        }

        .qr-panel {
          justify-items: start;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="brand">AIR Controller Desktop</div>
        <div id="serverStatus" class="status">BOOTING</div>
      </header>

      <main>
        <section class="card">
          <h2>Session Console</h2>
          <div class="row">
            <button id="openHostBtn" type="button">Advanced Host Dashboard</button>
            <button id="openBrowserBtn" class="subtle" type="button">Open Host In Browser</button>
            <button id="openGameControllersBtn" class="subtle" type="button">Open Game Controllers (Windows)</button>
          </div>

          <div class="url">
            <code id="localHostUrl">-</code>
            <button id="copyHostUrlBtn" class="subtle" type="button">Copy</button>
          </div>

          <p class="hint">Session is managed automatically. Scan QR or copy an invite link on your phone.</p>
          <div class="session-shell">
            <div>
              <div class="session-label">Active Session</div>
              <div id="sessionCodeBadge" class="session-code">------</div>
              <p id="sessionStatusHint" class="hint">Preparing session...</p>
              <div class="row">
                <button id="newSessionBtn" class="subtle" type="button">New Code</button>
                <button id="copyInviteBtn" class="subtle" type="button" disabled>Copy Invite Link</button>
              </div>
            </div>

            <div class="qr-panel">
              <div id="sessionQrBox" class="qr-box"></div>
              <p id="sessionQrHint" class="hint">QR will appear when session is ready.</p>
            </div>
          </div>

          <div id="inviteUrlList"></div>

          <div class="grid">
            <label>
              Bridge mode
              <select id="bridgeModeSelect">
                <option value="xbox">Virtual Xbox 360</option>
                <option value="ds4">Virtual DualShock 4</option>
                <option value="keyboard">Keyboard bridge</option>
              </select>
            </label>

            <label>
              Server URL for bridge
              <input id="serverUrlInput" placeholder="http://127.0.0.1:3000" />
            </label>

            <label>
              Player
              <input id="playerIndexInput" value="1" inputmode="numeric" />
            </label>
          </div>

          <label>
            <input id="dryRunInput" type="checkbox" style="margin-right: 0.4rem; width: auto;" />
            Dry run (no input injection)
          </label>

          <div class="row" style="margin-top: 0.6rem;">
            <button id="runSetupBtn" type="button">Run One-Click Setup</button>
            <button id="installBridgeBtn" class="subtle" type="button">Install Virtual Bridge Runtime</button>
            <button id="checkVirtualBtn" class="subtle" type="button">Recheck Virtual Driver</button>
            <button id="startBridgeBtn" type="button">Start Playing</button>
            <button id="stopBridgeBtn" class="warn" type="button">Stop Bridge</button>
          </div>

          <p id="setupStatus" class="hint">Setup: pending.</p>
          <p id="virtualStatus" class="hint">Virtual preflight: pending.</p>
          <p id="modeAdvice" class="hint">Compatibility advice will appear here.</p>
          <p id="bridgeHint" class="hint">Bridge idle.</p>
          <div id="bridgeList" class="bridge-list"></div>
        </section>

        <section class="card">
          <h2>Bridge Logs</h2>
          <div id="logBox" class="log"></div>
        </section>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
      const ui = {
        serverStatus: document.getElementById("serverStatus"),
        openHostBtn: document.getElementById("openHostBtn"),
        openBrowserBtn: document.getElementById("openBrowserBtn"),
        openGameControllersBtn: document.getElementById("openGameControllersBtn"),
        localHostUrl: document.getElementById("localHostUrl"),
        copyHostUrlBtn: document.getElementById("copyHostUrlBtn"),
        inviteUrlList: document.getElementById("inviteUrlList"),
        sessionCodeBadge: document.getElementById("sessionCodeBadge"),
        sessionStatusHint: document.getElementById("sessionStatusHint"),
        newSessionBtn: document.getElementById("newSessionBtn"),
        copyInviteBtn: document.getElementById("copyInviteBtn"),
        sessionQrBox: document.getElementById("sessionQrBox"),
        sessionQrHint: document.getElementById("sessionQrHint"),
        bridgeModeSelect: document.getElementById("bridgeModeSelect"),
        serverUrlInput: document.getElementById("serverUrlInput"),
        playerIndexInput: document.getElementById("playerIndexInput"),
        dryRunInput: document.getElementById("dryRunInput"),
        runSetupBtn: document.getElementById("runSetupBtn"),
        installBridgeBtn: document.getElementById("installBridgeBtn"),
        checkVirtualBtn: document.getElementById("checkVirtualBtn"),
        startBridgeBtn: document.getElementById("startBridgeBtn"),
        stopBridgeBtn: document.getElementById("stopBridgeBtn"),
        setupStatus: document.getElementById("setupStatus"),
        virtualStatus: document.getElementById("virtualStatus"),
        modeAdvice: document.getElementById("modeAdvice"),
        bridgeHint: document.getElementById("bridgeHint"),
        bridgeList: document.getElementById("bridgeList"),
        logBox: document.getElementById("logBox"),
      };

      let state = null;
      let autoServerUrl = "";
      let serverUrlWasEdited = false;
      let setupAutoTriggered = false;
      let lastQrValue = "";

      function normalizeCode(raw) {
        return String(raw || "")
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 6);
      }

      function appendLog(entry) {
        if (!entry || !entry.message) {
          return;
        }

        const line = document.createElement("div");
        line.className = `log-line ${entry.type || "stdout"}`;
        const timestamp = new Date(entry.at || Date.now()).toLocaleTimeString();
        const bridgePrefix = entry.bridgeId ? `[${entry.bridgeId}] ` : "";
        line.textContent = `[${timestamp}] ${bridgePrefix}${entry.message}`;
        ui.logBox.appendChild(line);
        ui.logBox.scrollTop = ui.logBox.scrollHeight;
      }

      function normalizePlayerIndex(raw) {
        const parsed = Number(raw);
        if (!Number.isFinite(parsed)) {
          return 1;
        }

        const integer = Math.floor(parsed);
        if (integer < 1) {
          return 1;
        }

        if (integer > 64) {
          return 64;
        }

        return integer;
      }

      function renderInviteUrls(session) {
        ui.inviteUrlList.innerHTML = "";
        const code = normalizeCode(session?.code || "");
        const urls = Array.isArray(session?.joinUrls) ? session.joinUrls : [];

        if (!code || urls.length === 0) {
          const empty = document.createElement("p");
          empty.className = "hint";
          empty.textContent = "Invite links will appear once a session is ready.";
          ui.inviteUrlList.appendChild(empty);
          return;
        }

        urls.forEach((url) => {
          const row = document.createElement("div");
          row.className = "url";

          const codeNode = document.createElement("code");
          codeNode.textContent = url;

          const controls = document.createElement("div");
          controls.className = "row";

          const copyButton = document.createElement("button");
          copyButton.type = "button";
          copyButton.className = "subtle";
          copyButton.textContent = "Copy";
          copyButton.addEventListener("click", () => copyText(url));

          const openButton = document.createElement("button");
          openButton.type = "button";
          openButton.className = "subtle";
          openButton.textContent = "Open";
          openButton.addEventListener("click", () => window.airDesktop.openUrl(url));

          controls.appendChild(copyButton);
          controls.appendChild(openButton);

          row.appendChild(codeNode);
          row.appendChild(controls);

          ui.inviteUrlList.appendChild(row);
        });
      }

      function renderSessionQr(joinUrl) {
        if (!joinUrl) {
          lastQrValue = "";
          ui.sessionQrBox.innerHTML = "";
          ui.sessionQrHint.textContent = "QR will appear when session is ready.";
          return;
        }

        if (joinUrl === lastQrValue && ui.sessionQrBox.childElementCount > 0) {
          return;
        }

        lastQrValue = joinUrl;
        ui.sessionQrBox.innerHTML = "";

        if (window.QRCode && typeof window.QRCode.toCanvas === "function") {
          window.QRCode.toCanvas(joinUrl, { width: 168, margin: 1 }, (error, canvas) => {
            if (error || !canvas) {
              ui.sessionQrHint.textContent = "QR render failed. Use Copy Invite Link.";
              return;
            }

            ui.sessionQrBox.appendChild(canvas);
            ui.sessionQrHint.textContent = "Scan from your phone to connect instantly.";
          });
          return;
        }

        const fallback = document.createElement("code");
        fallback.textContent = "QR unavailable";
        ui.sessionQrBox.appendChild(fallback);
        ui.sessionQrHint.textContent = "QR library unavailable. Use Copy Invite Link.";
      }

      function renderSessionState(session) {
        const code = normalizeCode(session?.code || "");
        ui.sessionCodeBadge.textContent = code || "------";
        ui.sessionCodeBadge.classList.toggle("ready", code.length === 6 && session?.status === "ready");

        ui.copyInviteBtn.disabled = !(code.length === 6 && session?.joinUrl);

        if (!session) {
          ui.sessionStatusHint.textContent = "Preparing session...";
          renderSessionQr("");
          return;
        }

        if (session.status === "ready" && code.length === 6) {
          const controllers = Number(session.controllerCount || 0);
          const bridges = Number(session.bridgeCount || 0);
          ui.sessionStatusHint.textContent = `Ready. ${controllers} phone(s), ${bridges} bridge(s) connected.`;
          renderSessionQr(session.joinUrl || "");
          return;
        }

        if (session.status === "creating" || session.status === "connecting") {
          ui.sessionStatusHint.textContent = "Creating session...";
          renderSessionQr("");
          return;
        }

        if (session.status === "error") {
          ui.sessionStatusHint.textContent = `Session error: ${session.lastError || "Unable to create session."}`;
          renderSessionQr("");
          return;
        }

        ui.sessionStatusHint.textContent = "Preparing session...";
        renderSessionQr(session.joinUrl || "");
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch (_error) {
          ui.bridgeHint.textContent = `Copy failed. URL: ${text}`;
        }
      }

      function renderBridgeState(bridges) {
        if (bridges.length === 0) {
          ui.bridgeHint.textContent = "Bridge idle.";
        } else {
          const labels = bridges
            .map((entry) => `${entry.id} ${entry.type || "bridge"} P${entry.playerIndex || "?"}`)
            .join(" | ");
          ui.bridgeHint.textContent = `Running bridges: ${bridges.length} (${labels})`;
        }

        ui.stopBridgeBtn.disabled = bridges.length === 0;
      }

      function renderBridgeList(bridges) {
        ui.bridgeList.innerHTML = "";

        if (bridges.length === 0) {
          return;
        }

        bridges.forEach((entry) => {
          const row = document.createElement("div");
          row.className = "bridge-item";

          const label = document.createElement("code");
          const startedAt = entry.startedAt ? new Date(entry.startedAt).toLocaleTimeString() : "--";
          label.textContent = `${entry.id} | ${entry.type || "bridge"} | P${entry.playerIndex || "?"} | ${startedAt}`;

          const stopBtn = document.createElement("button");
          stopBtn.type = "button";
          stopBtn.className = "warn";
          stopBtn.textContent = "Stop";
          stopBtn.addEventListener("click", async () => {
            await window.airDesktop.stopBridge({ bridgeId: entry.id });
            await refreshState();
          });

          row.appendChild(label);
          row.appendChild(stopBtn);
          ui.bridgeList.appendChild(row);
        });
      }

      function getSelectedVirtualDevice() {
        return ui.bridgeModeSelect.value === "ds4" ? "ds4" : "xbox";
      }

      function renderSetupStatus(setup) {
        if (!setup) {
          ui.runSetupBtn.disabled = false;
          ui.runSetupBtn.textContent = "Run One-Click Setup";
          ui.setupStatus.textContent = "Setup: unavailable.";
          return;
        }

        if (setup.status === "running") {
          ui.runSetupBtn.disabled = true;
          ui.runSetupBtn.textContent = "Setup Running...";
          ui.setupStatus.textContent = `Setup: running. ${setup.message || "Working..."}`;
          return;
        }

        ui.runSetupBtn.disabled = false;
        ui.runSetupBtn.textContent = "Run One-Click Setup";

        if (setup.status === "success") {
          ui.setupStatus.textContent = `Setup: complete. ${setup.message || ""}`;
          return;
        }

        if (setup.status === "pending_restart") {
          ui.setupStatus.textContent = `Setup: restart required. ${setup.message || ""}`;
          return;
        }

        if (setup.status === "failed") {
          ui.setupStatus.textContent = `Setup: failed. ${setup.message || "Review logs and retry."}`;
          return;
        }

        ui.setupStatus.textContent = `Setup: ${setup.message || "Not started."}`;
      }

      function renderVirtualStatus(check) {
        if (!check) {
          ui.virtualStatus.textContent = "Virtual preflight: unavailable.";
          return;
        }

        const checkedAt = check.checkedAt ? new Date(check.checkedAt).toLocaleTimeString() : "--";

        if (check.status === "not_required") {
          ui.virtualStatus.textContent = "Virtual preflight: not required on this OS.";
          return;
        }

        if (check.status === "unsupported") {
          ui.virtualStatus.textContent = `Virtual preflight: unsupported. ${check.message || ""}`;
          return;
        }

        if (check.status === "checking") {
          ui.virtualStatus.textContent = "Virtual preflight: checking runtime and driver...";
          return;
        }

        if (check.status === "ready") {
          const supported = [];
          if (check.devices?.xbox) {
            supported.push("Xbox");
          }
          if (check.devices?.ds4) {
            supported.push("DS4");
          }
          ui.virtualStatus.textContent = `Virtual preflight: ready (${supported.join(", ")}) at ${checkedAt}.`;
          return;
        }

        if (check.status === "failed") {
          ui.virtualStatus.textContent = `Virtual preflight: failed. ${check.message || "Check ViGEmBus driver."}`;
          return;
        }

        ui.virtualStatus.textContent = "Virtual preflight: not checked yet.";
      }

      function renderModeAdvice() {
        const selectedMode = ui.bridgeModeSelect.value;
        if (selectedMode === "keyboard") {
          ui.modeAdvice.textContent =
            "Keyboard mode: most games must run non-admin unless AIR Controller is also started as administrator.";
          return;
        }

        if (selectedMode === "ds4") {
          ui.modeAdvice.textContent =
            "DS4 mode: if the game does not detect controller, try Xbox mode first. Validate in joy.cpl, then disable Steam Input override for that game if needed. Start Bridge auto-runs setup if required.";
          return;
        }

        ui.modeAdvice.textContent =
          "Xbox mode: best compatibility. If joy.cpl shows input but game does not, restart the game and disable Steam Input per-game override. Start Bridge auto-runs setup if required.";
      }

      function updateStartButtonState() {
        const selectedMode = ui.bridgeModeSelect.value;
        const needsVirtualDriver = selectedMode !== "keyboard" && !ui.dryRunInput.checked;
        const setupRunning = state?.dependencySetup?.status === "running";
        let blockedReason = "";
        let hintReason = "";

        if (setupRunning) {
          blockedReason = "Dependency setup is still running.";
        } else if (needsVirtualDriver) {
          const check = state?.virtualBridgeCheck;
          const device = getSelectedVirtualDevice();
          const deviceReady = Boolean(check?.devices?.[device]);
          const ready = check?.status === "ready" && deviceReady;
          const platform = check?.platform;

          if (check?.status === "unsupported") {
            blockedReason = check?.message || "Virtual bridge is not supported on this OS.";
          } else if ((platform === "win32" || platform === "linux") && !ready) {
            hintReason =
              platform === "win32"
                ? "Not ready yet. Start Bridge will run dependency setup automatically."
                : check?.message || "Virtual bridge preflight not ready yet.";
          }
        }

        ui.startBridgeBtn.disabled = Boolean(blockedReason);
        ui.startBridgeBtn.title = blockedReason || hintReason;
      }

      async function refreshState() {
        const res = await window.airDesktop.getState();
        if (!res?.ok) {
          ui.serverStatus.textContent = "ERROR";
          return;
        }

        state = res;

        ui.serverStatus.textContent = "ONLINE";
        ui.serverStatus.classList.add("online");

        ui.localHostUrl.textContent = res.localHostUrl;

        const currentServerUrl = ui.serverUrlInput.value.trim();
        const shouldAutoSyncServerUrl =
          !serverUrlWasEdited || !currentServerUrl || currentServerUrl === autoServerUrl;
        if (shouldAutoSyncServerUrl) {
          ui.serverUrlInput.value = res.localOrigin;
          autoServerUrl = res.localOrigin;
        }

        renderSessionState(res.session || null);
        renderInviteUrls(res.session || null);
        const bridges = Array.isArray(res.bridges) ? res.bridges : [];
        renderBridgeState(bridges);
        renderBridgeList(bridges);
        renderSetupStatus(res.dependencySetup);
        renderVirtualStatus(res.virtualBridgeCheck);
        renderModeAdvice();
        updateStartButtonState();

        ui.logBox.innerHTML = "";
        (res.bridge?.logs || []).forEach(appendLog);
      }

      ui.openHostBtn.addEventListener("click", async () => {
        await window.airDesktop.openHostWindow();
      });

      ui.openBrowserBtn.addEventListener("click", async () => {
        if (state?.localHostUrl) {
          await window.airDesktop.openUrl(state.localHostUrl);
        }
      });

      ui.openGameControllersBtn.addEventListener("click", async () => {
        const res = await window.airDesktop.openGameControllers();
        if (!res?.ok) {
          ui.bridgeHint.textContent = res?.message || "Unable to open Game Controllers panel.";
        }
      });

      ui.copyHostUrlBtn.addEventListener("click", () => {
        if (state?.localHostUrl) {
          copyText(state.localHostUrl);
        }
      });

      ui.newSessionBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent = "Creating a new session code...";
        const res = await window.airDesktop.newSession({ reason: "desktop_new_code" });
        if (!res?.ok) {
          ui.bridgeHint.textContent = `Session creation failed: ${res?.error || "Unknown error"}`;
        } else {
          ui.bridgeHint.textContent = `New session ready: ${res?.session?.code || "------"}`;
        }
        await refreshState();
      });

      ui.copyInviteBtn.addEventListener("click", () => {
        const inviteUrl = state?.session?.joinUrl || "";
        if (!inviteUrl) {
          ui.bridgeHint.textContent = "Invite link is not ready yet.";
          return;
        }
        copyText(inviteUrl);
      });

      ui.installBridgeBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent = "Installing virtual bridge runtime...";
        const res = await window.airDesktop.installVirtualBridge();
        ui.bridgeHint.textContent = res.ok
          ? "Virtual bridge runtime ready."
          : `Install failed: ${res.error || "Unknown error"}`;
        await refreshState();
      });

      ui.checkVirtualBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent = "Checking virtual driver...";
        const res = await window.airDesktop.checkVirtualBridge({ force: true, autoSetup: true });
        if (!res?.ok) {
          ui.bridgeHint.textContent = `Virtual check failed: ${res?.check?.message || "Unknown error"}`;
        } else {
          ui.bridgeHint.textContent = "Virtual check passed.";
        }
        await refreshState();
      });

      ui.runSetupBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent = "Running one-click dependency setup...";
        const res = await window.airDesktop.runDependencySetup({
          force: true,
          auto: false,
          allowDriverInstall: true,
          openManualFallback: true,
        });

        if (res?.ok) {
          ui.bridgeHint.textContent = res?.requiresRestart
            ? "Setup completed. Restart Windows if virtual device is still unavailable."
            : "Setup completed successfully.";
        } else {
          ui.bridgeHint.textContent = `Setup failed: ${res?.error || "Unknown error"}`;
        }

        await refreshState();
      });

      ui.startBridgeBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent =
          "Starting bridge. Dependencies/driver will be prepared automatically if required.";

        const selected = ui.bridgeModeSelect.value;
        const payload = {
          code: normalizeCode(state?.session?.code || ""),
          serverUrl: ui.serverUrlInput.value.trim(),
          player: normalizePlayerIndex(ui.playerIndexInput.value),
          dryRun: ui.dryRunInput.checked,
          autoDependencySetup: true,
        };

        if (selected === "keyboard") {
          payload.type = "keyboard";
        } else {
          payload.type = "virtual";
          payload.device = selected;
        }

        const res = await window.airDesktop.startBridge(payload);
        if (!res.ok) {
          ui.bridgeHint.textContent = `Start failed: ${res.error || "Unknown error"}`;
        }

        await refreshState();
      });

      ui.stopBridgeBtn.addEventListener("click", async () => {
        await window.airDesktop.stopBridge({});
        await refreshState();
      });

      ui.bridgeModeSelect.addEventListener("change", updateStartButtonState);
      ui.bridgeModeSelect.addEventListener("change", renderModeAdvice);
      ui.dryRunInput.addEventListener("change", updateStartButtonState);
      ui.serverUrlInput.addEventListener("input", () => {
        serverUrlWasEdited = true;
      });
      ui.playerIndexInput.addEventListener("input", () => {
        ui.playerIndexInput.value = String(normalizePlayerIndex(ui.playerIndexInput.value));
      });

      window.airDesktop.onBridgeEvent((event) => {
        appendLog(event);

        if (event.type === "status") {
          refreshState();
        }
      });

      window.airDesktop.onDesktopEvent((event) => {
        if (event?.type === "session") {
          refreshState();
        }
      });

      refreshState().then(async () => {
        if (
          !setupAutoTriggered &&
          state?.virtualBridgeCheck?.platform === "win32" &&
          state?.dependencySetup?.status === "idle"
        ) {
          setupAutoTriggered = true;
          await window.airDesktop.runDependencySetup({
            force: false,
            auto: true,
            allowDriverInstall: true,
            openManualFallback: false,
          });
          await refreshState();
        }
      });
    </script>
  </body>
</html>
