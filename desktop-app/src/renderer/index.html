<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIR Controller Desktop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg0: #040812;
        --bg1: #0d1a2f;
        --panel: rgba(8, 20, 36, 0.8);
        --trace: #3df2cb;
        --warn: #ff9d43;
        --text: #ecf8ff;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "IBM Plex Sans", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 82% 12%, rgba(61, 242, 203, 0.2), transparent 30%),
          radial-gradient(circle at 9% 88%, rgba(255, 157, 67, 0.18), transparent 36%),
          linear-gradient(160deg, var(--bg0), var(--bg1));
        padding: 1.2rem;
      }

      .shell {
        width: min(1180px, 100%);
        margin: 0 auto;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 24px;
        overflow: hidden;
        backdrop-filter: blur(10px);
        background: linear-gradient(170deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.015));
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
      }

      .brand {
        font-family: "Bebas Neue", cursive;
        letter-spacing: 0.08em;
        font-size: 1.85rem;
      }

      .status {
        font-size: 0.78rem;
        font-weight: 700;
        border-radius: 999px;
        padding: 0.32rem 0.62rem;
        border: 1px solid rgba(255, 255, 255, 0.24);
      }

      .status.online {
        border: none;
        color: #032119;
        background: linear-gradient(100deg, var(--trace), #c8fff1);
      }

      main {
        padding: 1rem;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 0.9rem;
      }

      .card {
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        background: var(--panel);
        padding: 0.85rem;
      }

      h2 {
        margin: 0 0 0.6rem;
        font-family: "Bebas Neue", cursive;
        letter-spacing: 0.06em;
        font-size: 1.45rem;
        font-weight: 400;
      }

      .row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .url {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.45rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem 0.55rem;
      }

      .url code {
        word-break: break-all;
        font-size: 0.8rem;
      }

      label {
        display: grid;
        gap: 0.3rem;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        font-weight: 700;
      }

      input,
      select,
      button {
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 0.52rem 0.6rem;
        font-size: 0.88rem;
        font-family: inherit;
      }

      input {
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      button {
        border: none;
        color: #02160f;
        font-weight: 700;
        background: linear-gradient(110deg, var(--trace), #b6fceb);
        cursor: pointer;
      }

      button.subtle {
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
      }

      button.warn {
        color: #311500;
        background: linear-gradient(110deg, var(--warn), #ffc48c);
      }

      .hint {
        margin: 0.35rem 0 0;
        font-size: 0.77rem;
        opacity: 0.86;
      }

      .log {
        margin-top: 0.6rem;
        border: 1px solid rgba(255, 255, 255, 0.19);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.22);
        padding: 0.55rem;
        height: 250px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 0.76rem;
        line-height: 1.35;
        white-space: pre-wrap;
      }

      .log-line {
        margin: 0 0 0.38rem;
      }

      .log-line.stderr,
      .log-line.error {
        color: #ffb8b8;
      }

      .log-line.status {
        color: #9dfce7;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      @media (max-width: 960px) {
        main {
          grid-template-columns: 1fr;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="brand">AIR Controller Desktop</div>
        <div id="serverStatus" class="status">BOOTING</div>
      </header>

      <main>
        <section class="card">
          <h2>Session Console</h2>
          <div class="row">
            <button id="openHostBtn" type="button">Open Host Dashboard</button>
            <button id="openBrowserBtn" class="subtle" type="button">Open Host In Browser</button>
          </div>

          <div class="url">
            <code id="localHostUrl">-</code>
            <button id="copyHostUrlBtn" class="subtle" type="button">Copy</button>
          </div>

          <p class="hint">Use LAN URLs below in the phone app to open `/controller`.</p>
          <div id="lanUrlList"></div>

          <label>
            Session code
            <input id="sessionCodeInput" maxlength="6" placeholder="ABC123" />
          </label>

          <div class="grid">
            <label>
              Bridge mode
              <select id="bridgeModeSelect">
                <option value="xbox">Virtual Xbox 360</option>
                <option value="ds4">Virtual DualShock 4</option>
                <option value="keyboard">Keyboard bridge</option>
              </select>
            </label>

            <label>
              Server URL for bridge
              <input id="serverUrlInput" placeholder="http://127.0.0.1:3000" />
            </label>
          </div>

          <label>
            <input id="dryRunInput" type="checkbox" style="margin-right: 0.4rem; width: auto;" />
            Dry run (no input injection)
          </label>

          <div class="row" style="margin-top: 0.6rem;">
            <button id="installBridgeBtn" class="subtle" type="button">Install Virtual Bridge Runtime</button>
            <button id="startBridgeBtn" type="button">Start Bridge</button>
            <button id="stopBridgeBtn" class="warn" type="button">Stop Bridge</button>
          </div>

          <p id="bridgeHint" class="hint">Bridge idle.</p>
        </section>

        <section class="card">
          <h2>Bridge Logs</h2>
          <div id="logBox" class="log"></div>
        </section>
      </main>
    </div>

    <script>
      const ui = {
        serverStatus: document.getElementById("serverStatus"),
        openHostBtn: document.getElementById("openHostBtn"),
        openBrowserBtn: document.getElementById("openBrowserBtn"),
        localHostUrl: document.getElementById("localHostUrl"),
        copyHostUrlBtn: document.getElementById("copyHostUrlBtn"),
        lanUrlList: document.getElementById("lanUrlList"),
        sessionCodeInput: document.getElementById("sessionCodeInput"),
        bridgeModeSelect: document.getElementById("bridgeModeSelect"),
        serverUrlInput: document.getElementById("serverUrlInput"),
        dryRunInput: document.getElementById("dryRunInput"),
        installBridgeBtn: document.getElementById("installBridgeBtn"),
        startBridgeBtn: document.getElementById("startBridgeBtn"),
        stopBridgeBtn: document.getElementById("stopBridgeBtn"),
        bridgeHint: document.getElementById("bridgeHint"),
        logBox: document.getElementById("logBox"),
      };

      let state = null;

      function normalizeCode(raw) {
        return String(raw || "")
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 6);
      }

      function appendLog(entry) {
        if (!entry || !entry.message) {
          return;
        }

        const line = document.createElement("div");
        line.className = `log-line ${entry.type || "stdout"}`;
        const timestamp = new Date(entry.at || Date.now()).toLocaleTimeString();
        line.textContent = `[${timestamp}] ${entry.message}`;
        ui.logBox.appendChild(line);
        ui.logBox.scrollTop = ui.logBox.scrollHeight;
      }

      function renderLanUrls(urls) {
        ui.lanUrlList.innerHTML = "";

        if (!urls || urls.length === 0) {
          const empty = document.createElement("p");
          empty.className = "hint";
          empty.textContent = "No LAN IPv4 interface detected yet.";
          ui.lanUrlList.appendChild(empty);
          return;
        }

        urls.forEach((url) => {
          const row = document.createElement("div");
          row.className = "url";

          const code = document.createElement("code");
          code.textContent = url;

          const controls = document.createElement("div");
          controls.className = "row";

          const copyButton = document.createElement("button");
          copyButton.type = "button";
          copyButton.className = "subtle";
          copyButton.textContent = "Copy";
          copyButton.addEventListener("click", () => copyText(url));

          const openButton = document.createElement("button");
          openButton.type = "button";
          openButton.className = "subtle";
          openButton.textContent = "Open";
          openButton.addEventListener("click", () => window.airDesktop.openUrl(url));

          controls.appendChild(copyButton);
          controls.appendChild(openButton);

          row.appendChild(code);
          row.appendChild(controls);

          ui.lanUrlList.appendChild(row);
        });
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch (_error) {
          ui.bridgeHint.textContent = `Copy failed. URL: ${text}`;
        }
      }

      function renderBridgeState(bridge) {
        if (bridge.running) {
          const startedAt = bridge.startedAt ? new Date(bridge.startedAt).toLocaleTimeString() : "-";
          ui.bridgeHint.textContent = `Bridge running: ${bridge.type || "unknown"} (since ${startedAt})`;
        } else {
          ui.bridgeHint.textContent = "Bridge idle.";
        }

        ui.startBridgeBtn.disabled = bridge.running;
        ui.stopBridgeBtn.disabled = !bridge.running;
      }

      async function refreshState() {
        const res = await window.airDesktop.getState();
        if (!res?.ok) {
          ui.serverStatus.textContent = "ERROR";
          return;
        }

        state = res;

        ui.serverStatus.textContent = "ONLINE";
        ui.serverStatus.classList.add("online");

        ui.localHostUrl.textContent = res.localHostUrl;
        ui.serverUrlInput.value = res.localOrigin;

        renderLanUrls(res.lanControllerUrls || []);
        renderBridgeState(res.bridge || { running: false });

        ui.logBox.innerHTML = "";
        (res.bridge?.logs || []).forEach(appendLog);
      }

      ui.openHostBtn.addEventListener("click", async () => {
        await window.airDesktop.openHostWindow();
      });

      ui.openBrowserBtn.addEventListener("click", async () => {
        if (state?.localHostUrl) {
          await window.airDesktop.openUrl(state.localHostUrl);
        }
      });

      ui.copyHostUrlBtn.addEventListener("click", () => {
        if (state?.localHostUrl) {
          copyText(state.localHostUrl);
        }
      });

      ui.installBridgeBtn.addEventListener("click", async () => {
        ui.bridgeHint.textContent = "Installing virtual bridge runtime...";
        const res = await window.airDesktop.installVirtualBridge();
        ui.bridgeHint.textContent = res.ok
          ? "Virtual bridge runtime ready."
          : `Install failed: ${res.error || "Unknown error"}`;
      });

      ui.startBridgeBtn.addEventListener("click", async () => {
        const code = normalizeCode(ui.sessionCodeInput.value);

        if (code.length !== 6) {
          ui.bridgeHint.textContent = "Session code must be exactly 6 characters.";
          return;
        }

        const selected = ui.bridgeModeSelect.value;
        const payload = {
          code,
          serverUrl: ui.serverUrlInput.value.trim(),
          dryRun: ui.dryRunInput.checked,
        };

        if (selected === "keyboard") {
          payload.type = "keyboard";
        } else {
          payload.type = "virtual";
          payload.device = selected;
        }

        const res = await window.airDesktop.startBridge(payload);
        if (!res.ok) {
          ui.bridgeHint.textContent = `Start failed: ${res.error || "Unknown error"}`;
        }

        await refreshState();
      });

      ui.stopBridgeBtn.addEventListener("click", async () => {
        await window.airDesktop.stopBridge();
        await refreshState();
      });

      window.airDesktop.onBridgeEvent((event) => {
        appendLog(event);

        if (event.type === "status") {
          refreshState();
        }
      });

      refreshState();
    </script>
  </body>
</html>
